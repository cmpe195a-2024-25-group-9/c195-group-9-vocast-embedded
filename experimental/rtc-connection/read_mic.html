<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audio Stream Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }
        #audioDataDisplay {
            font-size: 14px;
            margin-top: 20px;
            white-space: pre-wrap; /* Preserve line breaks */
            max-height: 300px;
            overflow-y: auto; /* Add scrolling if content overflows */
            border: 1px solid black;
            padding: 10px;
        }
        #status {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Audio Stream Control</h1>
    <button onclick="startAudio()">Start Microphone</button>
    <button onclick="stopAudio()">Stop Microphone</button>
    <div id="status"></div>
    <div id="audioDataDisplay">Audio Data Stream:</div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let stream;

        const esp8266IP = 'http://10.251.93.130/upload'; // Replace with your ESP8266 IP

        function startAudio() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(_stream) {
                        stream = _stream; // Store stream globally for stopping later
                        document.getElementById("status").innerText = "Microphone active";

                        // Initialize MediaRecorder to capture audio
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.ondataavailable = handleDataAvailable;
                        mediaRecorder.onstop = handleStop;

                        // Start recording in chunks of 1 second
                        mediaRecorder.start(1000); // Record in chunks of 1 second

                    })
                    .catch(function(err) {
                        console.error('Error accessing microphone:', err);
                        document.getElementById("status").innerText = "Microphone access error.";
                    });
            } else {
                alert("Your browser does not support audio capture.");
            }
        }

        function handleDataAvailable(event) {
            if (event.data.size > 0) {
                audioChunks.push(event.data);

                // Convert audio chunk to base64 and display it
                const reader = new FileReader();
                reader.onloadend = function() {
                    const base64data = reader.result.split(',')[1]; // Get base64 string
                    displayAudioData(base64data);

                    // Send base64 data to ESP8266
                    sendToESP(base64data);
                };
                reader.readAsDataURL(event.data); // Convert blob to base64
            }
        }

        function handleStop() {
            document.getElementById("status").innerText = "Microphone stopped.";
        }

        function stopAudio() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                stream.getTracks().forEach(track => track.stop());
                document.getElementById("status").innerText = "Microphone stopped.";
            }
        }

        function displayAudioData(data) {
            const displayDiv = document.getElementById('audioDataDisplay');
            displayDiv.innerText += `${data}\n`; // Append new data with line break

            // Scroll down automatically as new data comes in
            displayDiv.scrollTop = displayDiv.scrollHeight;
        }

        function sendToESP(audioData) {
            const formData = new FormData();
            formData.append('audio', audioData);

            fetch(esp8266IP, {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => console.log('ESP8266 Response:', data))
            .catch(err => console.error('Error sending audio data:', err));
        }
    </script>
</body>
</html>